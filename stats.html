<!DOCTYPE html>
<html>
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
 <title>Statistics</title>
 <link rel="stylesheet" href="Math 8.css">
 <style>
 /* Additional styles for stats display */
 .stats-container {
 max-width: 800px;
 margin: 20px auto;
 padding: 20px;
 }

 .user-info {
 background: #f8f9fa;
 border-radius: 10px;
 padding: 20px;
 margin-bottom: 30px;
 display: flex;
 align-items: center;
 gap: 20px;
 }

 .user-avatar {
 width: 80px;
 height: 80px;
 border-radius: 50%;
 border: 3px solid #007bff;
 }

 .user-details h2 {
 margin: 0;
 color: #333;
 }

 .user-details p {
 margin: 5px 0;
 color: #666;
 }

 .stats-grid {
 display: grid;
 grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
 gap: 20px;
 margin-bottom: 30px;
 }

 .stat-card {
 background: white;
 border-radius: 10px;
 padding: 20px;
 text-align: center;
 box-shadow: 0 2px 10px rgba(0,0,0,0.1);
 border-left: 4px solid #007bff;
 }

 .stat-number {
 font-size: 2.5em;
 font-weight: bold;
 color: #007bff;
 margin-bottom: 10px;
 }

 .stat-label {
 color: #666;
 font-size: 0.9em;
 text-transform: uppercase;
 letter-spacing: 1px;
 }

 .loading {
 text-align: center;
 padding: 50px;
 color: #666;
 }

 .error {
 background: #f8d7da;
 color: #721c24;
 padding: 15px;
 border-radius: 5px;
 margin: 20px;
 }

 .offline-indicator {
 background: #fff3cd;
 color: #856404;
 padding: 10px;
 text-align: center;
 border-radius: 5px;
 margin-bottom: 20px;
 display: none;
 }
 </style>
</head>
<body>
 <div class="header">
 <a class="backbutton" href="Dashboard.html">
 <img src="backbutton.png" alt="Back"/>
 </a>
 <div class="title">
 <h1>Math 7 Statistics</h1>
 </div>
 </div>

 <div class="offline-indicator" id="offlineIndicator">
 You're offline. Some data may not be up to date.
 </div>

 <div class="stats-container">
 <!-- Loading State -->
 <div id="loadingState" class="loading">
 <div>Loading your statistics...</div>
 </div>

 <!-- Error State -->
 <div id="errorState" class="error" style="display: none;">
 <strong>Error:</strong> <span id="errorMessage"></span>
 </div>

 <!-- User Info Section -->
 <div id="userInfoSection" class="user-info" style="display: none;">
 <img id="userAvatar" class="user-avatar" src="" alt="Profile Picture">
 <div class="user-details">
 <h2 id="userName">Loading...</h2>
 <p id="userEmail">Loading...</p>
 <p><strong>User ID:</strong> <span id="userId">Loading...</span></p>
 </div>
 </div>

 <!-- Statistics Grid -->
 <div id="statsGrid" class="stats-grid" style="display: none;">
 <div class="stat-card">
 <div id="QuizCompletion" class="stat-number">0</div>
 <div class="stat-label">Quizzes Completed</div>
 </div>

 <div class="stat-card">
 <div id="streakCount" class="stat-number">0</div>
 <div class="stat-label">Day Streak</div>
 </div>

 <div class="stat-card">
 <div id="totalTimeSpent" class="stat-number">0m</div>
 <div class="stat-label">Time Spent</div>
 </div>

 <div class="stat-card">
 <div id="lastLoginDate" class="stat-number">Never</div>
 <div class="stat-label">Last Login</div>
 </div>

 <div class="stat-card">
 <div id="notificationStatus" class="stat-number">OFF</div>
 <div class="stat-label">Notifications</div>
 </div>

 <div class="stat-card">
 <div id="accountCreated" class="stat-number">Unknown</div>
 <div class="stat-label">Member Since</div>
 </div>
 </div>

 <!-- Action Buttons -->
 <div id="actionButtons" style="display: none; text-align: center; margin-top: 30px;">
 <button id="refreshStats" style="padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
 Refresh Stats
 </button>
 <button id="logout-btn" style="padding: 10px 20px; margin: 5px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">
 Logout
 </button>
 </div>
 </div>

 <script type="module">
 // Import Firebase functions
 import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
 import { doc, setDoc, getDoc, updateDoc, increment, arrayUnion, collection, addDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

 // Import your Firebase config - adjust the path as needed
 import { auth, db } from "./firebase.js"; // Make sure this path is correct

 // Global variables
 let currentUser = null;
 let userProgressData = null;

 // Initialize user progress in Firestore
 const initializeUserProgress = async (user) => {
 try {
 const progressRef = doc(db, 'userProgress', user.uid);
 const progressDoc = await getDoc(progressRef);

 if (!progressDoc.exists()) {
 // Create new user progress document
 const initialData = {
 uid: user.uid,
 displayName: user.displayName,
 email: user.email,
 QuizCompletion: 0,
 streakCount: 1,
 lastLoginDate: new Date(),
 notifications: false,
 totalTimeSpent: 0,
 accountCreated: new Date()
 };

 await setDoc(progressRef, initialData);
 console.log('Created new user progress document');
 return initialData;
 } else {
 // Update existing user's last login
 await updateDoc(progressRef, {
 lastLoginDate: new Date(),
 displayName: user.displayName, // Update in case it changed
 email: user.email
 });

 return progressDoc.data();
 }
 } catch (error) {
 console.error('Error initializing user progress:', error);
 throw error;
 }
 };

 // Get user progress data from Firestore
 const getUserProgressData = async (userId) => {
 try {
 const progressRef = doc(db, 'userProgress', userId);
 const progressDoc = await getDoc(progressRef);

 if (progressDoc.exists()) {
 return progressDoc.data();
 } else {
 throw new Error('User progress data not found');
 }
 } catch (error) {
 console.error('Error getting user progress:', error);
 throw error;
 }
 };

 // Update user profile display
 function updateUserProfile(user) {
 const nameElement = document.getElementById("userName");
 const emailElement = document.getElementById("userEmail");
 const imgElement = document.getElementById("userAvatar");
 const userIdElement = document.getElementById("userId");

 if (nameElement) nameElement.textContent = user.displayName || "No name provided";
 if (emailElement) emailElement.textContent = user.email || "No email";
 if (userIdElement) userIdElement.textContent = user.uid || "Unknown";

 if (imgElement) {
 imgElement.alt = user.displayName || "Profile photo";
 if (user.photoURL) {
 imgElement.src = user.photoURL;
 } else {
 // Use a default avatar or initials
 imgElement.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || user.email)}&background=007bff&color=fff&size=80`;
 }
 }
 }

 // Format time from seconds to readable format
 function formatTime(seconds) {
 if (!seconds || seconds === 0) return '0m';

 const hours = Math.floor(seconds / 3600);
 const minutes = Math.floor((seconds % 3600) / 60);

 if (hours > 0) {
 return `${hours}h ${minutes}m`;
 }
 return `${minutes}m`;
 }

 // Format date to readable format
 function formatDate(dateValue) {
 if (!dateValue) return 'Unknown';

 let date;
 if (dateValue.toDate) {
 // Firestore Timestamp
 date = dateValue.toDate();
 } else if (dateValue instanceof Date) {
 date = dateValue;
 } else {
 date = new Date(dateValue);
 }

 return date.toLocaleDateString('en-US', {
 year: 'numeric',
 month: 'short',
 day: 'numeric'
 });
 }

 // Update statistics display
 function updateStatsDisplay(progressData) {
 try {
 // Update each stat
 const quizElement = document.getElementById('quizCompletion');
 const streakElement = document.getElementById('streakCount');
 const timeElement = document.getElementById('totalTimeSpent');
 const loginElement = document.getElementById('lastLoginDate');
 const notificationElement = document.getElementById('notificationStatus');
 const accountElement = document.getElementById('accountCreated');

 if (quizElement) quizElement.textContent = progressData.QuizCompletion || 0;
 if (streakElement) streakElement.textContent = progressData.streakCount || 0;
 if (timeElement) timeElement.textContent = formatTime(progressData.totalTimeSpent || 0);
 if (loginElement) loginElement.textContent = formatDate(progressData.lastLoginDate);
 if (notificationElement) notificationElement.textContent = progressData.notifications ? 'ON' : 'OFF';
 if (accountElement) accountElement.textContent = formatDate(progressData.accountCreated);

 console.log('Statistics updated successfully');
 } catch (error) {
 console.error('Error updating stats display:', error);
 }
 }

 // Show loading state
 function showLoading() {
 document.getElementById('loadingState').style.display = 'block';
 document.getElementById('errorState').style.display = 'none';
 document.getElementById('userInfoSection').style.display = 'none';
 document.getElementById('statsGrid').style.display = 'none';
 document.getElementById('actionButtons').style.display = 'none';
 }

 // Show error state
 function showError(message) {
 document.getElementById('loadingState').style.display = 'none';
 document.getElementById('errorState').style.display = 'block';
 document.getElementById('errorMessage').textContent = message;
 document.getElementById('userInfoSection').style.display = 'none';
 document.getElementById('statsGrid').style.display = 'none';
 document.getElementById('actionButtons').style.display = 'block';
 }

 // Show data (success state)
 function showData() {
 document.getElementById('loadingState').style.display = 'none';
 document.getElementById('errorState').style.display = 'none';
 document.getElementById('userInfoSection').style.display = 'flex';
 document.getElementById('statsGrid').style.display = 'grid';
 document.getElementById('actionButtons').style.display = 'block';
 }

 // Load and display user data
 async function loadUserData(user) {
 try {
 showLoading();

 // Initialize/get user progress
 userProgressData = await initializeUserProgress(user);

 // Update UI
 updateUserProfile(user);
 updateStatsDisplay(userProgressData);

 showData();

 } catch (error) {
 console.error('Error loading user data:', error);
 showError(`Failed to load user data: ${error.message}`);
 }
 }

 // Refresh statistics
 async function refreshStats() {
 if (!currentUser) return;

 try {
 showLoading();
 userProgressData = await getUserProgressData(currentUser.uid);
 updateStatsDisplay(userProgressData);
 showData();
 } catch (error) {
 console.error('Error refreshing stats:', error);
 showError(`Failed to refresh data: ${error.message}`);
 }
 }

 // Auth state change listener
 onAuthStateChanged(auth, async (user) => {
 if (user) {
 console.log('User signed in:', user.email);
 currentUser = user;
 await loadUserData(user);
 } else {
 console.log('User signed out');
 // Redirect to login page
 window.location.href = "index.html"; // Adjust path as needed
 }
 });

 // Event listeners
 document.addEventListener('DOMContentLoaded', () => {
 // Logout button
 const logoutBtn = document.getElementById("logout-btn");
 if (logoutBtn) {
 logoutBtn.addEventListener("click", async () => {
 try {
 await signOut(auth);
 window.location.href = "index.html"; // Adjust path as needed
 } catch (err) {
 console.error("Error signing out:", err);
 alert("Failed to sign out. Try again.");
 }
 });
 }

 // Refresh button
 const refreshBtn = document.getElementById("refreshStats");
 if (refreshBtn) {
 refreshBtn.addEventListener("click", refreshStats);
 }

 // Check if user is online/offline
 window.addEventListener('online', () => {
 document.getElementById('offlineIndicator').style.display = 'none';
 if (currentUser) refreshStats();
 });

 window.addEventListener('offline', () => {
 document.getElementById('offlineIndicator').style.display = 'block';
 });
 });

 // Utility function to update a specific stat (can be called from other scripts)
 window.updateUserStat = async function(statName, value) {
 if (!currentUser) return;

 try {
 const progressRef = doc(db, 'userProgress', currentUser.uid);
 await updateDoc(progressRef, {
 [statName]: value,
 lastLoginDate: new Date()
 });

 // Refresh the display
 await refreshStats();
 } catch (error) {
 console.error('Error updating stat:', error);
 }
 };

 // Utility function to increment a stat
 window.incrementUserStat = async function(statName, incrementBy = 1) {
 if (!currentUser) return;

 try {
 const progressRef = doc(db, 'userProgress', currentUser.uid);
 await updateDoc(progressRef, {
 [statName]: increment(incrementBy),
 lastLoginDate: new Date()
 });

 // Refresh the display
 await refreshStats();
 } catch (error) {
 console.error('Error incrementing stat:', error);
 }
 };

 // Make functions globally available for debugging
 window.refreshStats = refreshStats;
 window.loadUserData = loadUserData;
 </script>
</body>
</html>